#!/usr/bin/env bash
# Lint Swift sources using SwiftLint with repo config.
set -euo pipefail
ROOT_DIR=$(cd "$(dirname "$0")/.." && pwd)
CONFIG="$ROOT_DIR/.swiftlint.yml"
CACHE_PATH="$ROOT_DIR/.tmp/swiftlint.cache"

mkdir -p "$(dirname "$CACHE_PATH")"

# Resolve swiftlint binary with optional override
if [[ -n "${SWIFTLINT_BIN:-}" && -x "${SWIFTLINT_BIN}" ]]; then
  SWIFTLINT="$SWIFTLINT_BIN"
else
  SWIFTLINT=$(command -v swiftlint 2>/dev/null || true)
fi

if [[ -z "${SWIFTLINT}" || ! -x "${SWIFTLINT}" ]]; then
  echo "swiftlint not found. Install via: brew install swiftlint" >&2
  exit 127
fi

MODE=${1:-lint}
case "$MODE" in
  fix|autocorrect)
    exec "$SWIFTLINT" --config "$CONFIG" --cache-path "$CACHE_PATH" autocorrect
    ;;
  --help|-h|help)
    echo "Usage: bin/lint [lint|fix]"; exit 0
    ;;
  *)
    exec "$SWIFTLINT" --config "$CONFIG" --cache-path "$CACHE_PATH" lint --strict
    ;;
esac
